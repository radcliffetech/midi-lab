<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MIDI Live</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .note-entry {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      padding: 8px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .velocity-bar {
      height: 10px;
      background: linear-gradient(to right, #0d6efd, #6610f2);
      margin-left: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<div class="container mt-4">
  <h1 class="mb-4 text-center">🎛 MIDI Live Monitor</h1>
  <form id="sendForm" class="mb-4 d-flex gap-2">
    <input type="number" id="noteInput" class="form-control" placeholder="MIDI Note (0-127)" min="0" max="127" required>
    <input type="number" id="velocityInput" class="form-control" placeholder="Velocity (0-127)" min="0" max="127" required>
    <button type="submit" class="btn btn-primary">Send</button>
  </form>
  <div id="messages" class="d-flex flex-column gap-2"></div>
</div>

<script>
function midiNoteToName(midi) {
  const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
  const octave = Math.floor(midi / 12) - 1;
  return notes[midi % 12] + octave;
}

const socket = new WebSocket("ws://" + location.host + "/ws");

socket.onopen = () => {
  console.log("✅ WebSocket connection established!");
};

socket.onerror = (err) => {
  console.error("❌ WebSocket error:", err);
};

document.getElementById('sendForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const note = parseInt(document.getElementById('noteInput').value);
  const velocity = parseInt(document.getElementById('velocityInput').value);
  if (socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ note, velocity }));
  }
});

socket.onmessage = (event) => {
  const msg = JSON.parse(event.data);
  const noteName = midiNoteToName(msg.note);

  const container = document.createElement("div");
  container.className = "note-entry";

  const noteText = document.createElement("div");
  noteText.innerHTML = `<strong>${noteName}</strong> (Velocity: ${msg.velocity})`;

  const velocityBar = document.createElement("div");
  velocityBar.className = "velocity-bar";
  velocityBar.style.width = (msg.velocity * 1.5) + "px";

  container.appendChild(noteText);
  container.appendChild(velocityBar);

  const messages = document.getElementById("messages");
  messages.appendChild(container);

  // Auto-scroll to bottom
  messages.scrollTop = messages.scrollHeight;
};
</script>

</body>
</html>